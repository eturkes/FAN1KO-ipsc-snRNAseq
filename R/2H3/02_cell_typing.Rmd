---
title: '02 Cell Typing - `r unlist(strsplit(getwd(), "/"))[6]`'
author:
  - name: "Emir Turkes [emir.turkes@eturkes.com]"
  - name: "UK Dementia Research Institute at UCL"
date: '`r strftime(Sys.time(), "%B %d, %Y")`'
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(
    "..", "..", "results", unlist(strsplit(getwd(), "/"))[6], "02_cell_typing.html"
  ))})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.95em; padding-left: 35px; text-indent: 0;
}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [FAN1 KO iPSC snRNAseq](https://github.com/eturkes/FAN1KO-ipsc-snRNAseq).*

The data here will be referenced using the name ``r unlist(strsplit(getwd(), "/"))[6]``.

```{r}
#    This file is part of FAN1KO-ipsc-snRNAseq.
#    Copyright (C) 2022  Emir Turkes, Emma Bunting, Jessica Olive,
#    Jasmine Donaldson, Sarah Tabrizi, UK Dementia Research Institute at
#    UCL
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

packages <- c("conflicted", "Seurat", "dplyr", "ggrepel", "ggplot2", "GSVA")
invisible(suppressPackageStartupMessages(lapply(packages, library, character.only = TRUE)))
source(file.path("..", "utils.R"))

analysis_no <- 2
data_name <- unlist(strsplit(getwd(), "/"))[6] # Name of dataset.
data_dir <- file.path("..", "..", "data") # Backed up data.
results_dir <- file.path("..", "..", "results")

# Unique cache directory for each analysis number.
# ------------------------------------------------
cache_dir <- file.path("..", "..", "cache", data_name, paste0("0", analysis_no))
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}
# ------------------------------------------------

knitr::opts_chunk$set(fig.width = 10, fig.height = 7, dpi = 300)
```

# Prep

```{r}
seurat <- readRDS(file.path(cache_dir, "..", "01", "all_seurat.rds"))
seurat

red_dim_plot(seurat, "umap1", "umap2", "seurat_clusters", "cat")
```

# Individual Marker Genes

## Smith-Geater

```{r}
smith_markers <- vector("list", length = 7)
names(smith_markers) <- c(
  "mature neuron", "D1 and D2+ spiny neurons", "NSC", "D1+ spiny and cholinergic striatal neurons",
  "D1+ spiny neurons", "NPCs", "immature neurons"
)
smith_markers[[1]] <- c("TPD52L1", "MEF2C", "PAX6", "SIX3")
smith_markers[[2]] <- c("MEIS2", "DLX5", "HPCA")
smith_markers[[3]] <- c("NES", "CCND1")
smith_markers[[4]] <- c("DLX5", "ISL1", "RAC3", "ARG2")
smith_markers[[5]] <- c("MEIS2", "PPP1R1A", "CAMKV", "RAC3", "GRIN2B")
smith_markers[[6]] <- c("CCND1", "HOMER3", "EBF1")
smith_markers[[7]] <- c("VGF", "H1F0")

for (i in seq_along(smith_markers)) {
  print(names(smith_markers)[i])
  print(gene_plot(list(seurat = seurat), "seurat", smith_markers[[i]]))
}
```

## Tran

```{r}
tran_markers <- read.delim(file.path(data_dir, "gene-sets", "tran_markers.tsv"))
tran_markers <- as.list(tran_markers)

for (i in seq_along(tran_markers)) {
  print(names(tran_markers)[i])
  print(gene_plot(list(seurat = seurat), "seurat", tran_markers[[i]][1:4])) # Just look at top 4 markers.
}
```

# Gene Sets

## Smith-Geater

```{r}
rds <- file.path(cache_dir, "smith_gsva.rds")
if (file.exists(rds)) {
  gsva <- readRDS(rds)
} else {
  gsva <- gsva(as.matrix(GetAssayData(seurat)), smith_markers, method = "ssgsea", ssgsea.norm = FALSE, verbose = FALSE)
  saveRDS(gsva, rds)
}
gsva <- (2 * (gsva - min(gsva)) / (max(gsva) - min(gsva))) - 1

gsva_seurat <- CreateAssayObject(data = gsva)
seurat[["GSVA"]] <- gsva_seurat
DefaultAssay(seurat) <- "GSVA"

# Loop through gene sets, plotting them four at a time.
idx_start <- 0
idx_end <- 0
for (i in seq(ceiling(nrow(seurat) / 4))) { # Find number of rounds needed to loop through all gene sets.
  idx_start <- idx_end + 1
  if (i == nrow(seurat)) { # Special case for the last round.
    idx_end <- idx_start + (nrow(seurat) - idx_start)
  } else {
    idx_end <- idx_start + 3
  }
  print(gene_plot(list(seurat = seurat), "seurat", rownames(seurat)[idx_start:idx_end]))
}

DefaultAssay(seurat) <- "SCT"
```

## Tran

```{r}
rds <- file.path(cache_dir, "tran_gsva.rds")
if (file.exists(rds)) {
  gsva <- readRDS(rds)
} else {
  gsva <- gsva(as.matrix(GetAssayData(seurat)), tran_markers, method = "ssgsea", ssgsea.norm = FALSE, verbose = FALSE)
  saveRDS(gsva, rds)
}
gsva <- (2 * (gsva - min(gsva)) / (max(gsva) - min(gsva))) - 1

gsva_seurat <- CreateAssayObject(data = gsva)
seurat[["GSVA"]] <- gsva_seurat
DefaultAssay(seurat) <- "GSVA"

# Loop through gene sets, plotting them four at a time.
idx_start <- 0
idx_end <- 0
for (i in seq(ceiling(nrow(seurat) / 4))) { # Find number of rounds needed to loop through all gene sets.
  idx_start <- idx_end + 1
  if (i == nrow(seurat)) { # Special case for the last round.
    idx_end <- idx_start + (nrow(seurat) - idx_start)
  } else {
    idx_end <- idx_start + 3
  }
  print(gene_plot(list(seurat = seurat), "seurat", rownames(seurat)[idx_start:idx_end]))
}

DefaultAssay(seurat) <- "SCT"
```

# References

This is the concluding section of the document. Here we output the `sessionInfo` and create a bibliography for works cited.

```{r}
sessionInfo()
```
